<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­ç»ƒä¹ å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            font-size: 14px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 1.8rem;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

        .header p {
            font-size: 0.95rem;
            margin: 0;
            opacity: 0.9;
        }

        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }

        .controls.collapsed {
            max-height: 60px;
            overflow: hidden;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            border-bottom: 1px solid #e8e8e8;
            margin-bottom: 15px;
        }

        .controls-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #333;
            font-weight: 600;
        }

        .toggle-icon {
            font-size: 1.2rem;
            color: #666;
            transition: transform 0.3s ease;
        }

        .controls.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .controls-content {
            transition: all 0.3s ease;
        }

        .controls.collapsed .controls-content {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        .controls.hidden {
            display: none;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 10px 12px;
            background: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            flex-wrap: nowrap;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-row:hover {
            border-color: #007aff;
        }

        .control-row label {
            font-weight: 500;
            color: #333;
            min-width: 70px;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .control-row select, .control-row input, .control-row button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .control-row select:focus, .control-row input:focus {
            outline: none;
            border-color: #007aff;
        }

        .control-row input[type="checkbox"] {
            appearance: none;
            width: 14px;
            height: 14px;
            border: 1px solid #ddd;
            border-radius: 2px;
            background: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            margin: 0;
            flex-shrink: 0;
        }
        
        .control-row input[type="checkbox"]:hover {
            border-color: #007aff;
        }

        .control-row input[type="checkbox"]:checked {
            background-color: #007aff;
            border-color: #007aff;
        }

        .control-row input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 1px;
            width: 4px;
            height: 6px;
            border: solid white;
            border-width: 0 1px 1px 0;
            transform: rotate(45deg);
        }

        .control-row input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.1);
        }

        /* ç§»åŠ¨ç«¯checkboxç¼©æ”¾å’Œé—´è·è°ƒæ•´ */
        @media (max-width: 600px) {
            .control-row input[type="checkbox"] {
                margin: 0 !important;
                vertical-align: middle;
            }
            
            .control-row label[for="wrongQuestionsOnly"],
            .control-row label[for="randomQuestions"] {
                margin: 0 !important;
                padding-right: 2px !important;
            }
            
            .control-row {
                gap: 2px !important;
            }
        }

        /* è°ƒæ•´checkboxä¸labelçš„é—´è· */
        .control-row label[for="wrongQuestionsOnly"],
        .control-row label[for="randomQuestions"] {
            margin-right: 0;
        }

        .control-row .wrong-questions-info {
            font-size: 0.8rem;
            color: #666;
            margin: 0;
            white-space: nowrap;
        }

        .start-btn {
            background: #28a745 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
            min-width: 80px !important;
            white-space: nowrap !important;
        }

        .start-btn:hover {
            background: #218838 !important;
        }

        .reset-btn {
            background: #007aff !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            transition: all 0.3s ease !important;
            margin-left: 10px !important;
            min-width: 80px !important;
            display: inline-block !important;
            white-space: nowrap !important;
        }

        .reset-btn:hover {
            background: #0056cc !important;
        }

        #prevBtn, #nextBtn {
            background: #007aff !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            transition: all 0.2s ease !important;
            margin-left: 8px !important;
            min-width: 80px !important;
            white-space: nowrap !important;
        }
        
        #prevBtn:hover, #nextBtn:hover {
            background: #0056cc !important;
        }

        #wrongQuestionsBtn {
            background: #dc3545 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            transition: all 0.3s ease !important;
            margin-left: 10px !important;
            min-width: 80px !important;
            white-space: nowrap !important;
        }
        
        #wrongQuestionsBtn:hover {
            background: #c82333 !important;
        }

        .practice-area {
            background: white;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 300px;
            border: 1px solid #e8e8e8;
        }

        .question-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
            margin-bottom: 16px;
        }

        .question-type {
            background: #007aff;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .question-content {
            font-size: 1rem;
            line-height: 1.6;
            margin: 16px 0;
            color: #333;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .answer-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 16px 0;
        }

        .choice-option {
            padding: 12px 16px;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
            text-align: left;
        }

        .choice-option:hover {
            border-color: #007aff;
            background: #f8f9ff;
        }

        .choice-option.selected {
            border-color: #007aff;
            background: #e3f2fd;
        }

        .choice-option.correct {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .choice-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .feedback {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 16px 0;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .feedback.hidden {
            display: none !important;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-item {
            text-align: center;
            padding: 8px 16px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            min-width: 80px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #007aff;
            margin-bottom: 4px;
            display: block;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #495057;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e8e8e8;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: #007aff;
            transition: width 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-screen h2 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }

        .welcome-screen p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .start-btn:hover {
            background: #0056cc !important;
        }

        /* æ–°å¢ï¼šé¢˜ç›®ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .question-stats {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: #666;
            margin-left: 12px;
        }

        .question-stats .current-total {
            font-weight: 600;
            color: #007aff;
        }

        .question-stats .correct-count {
            color: #28a745;
            font-weight: 500;
        }

        .question-stats .incorrect-count {
            color: #dc3545;
            font-weight: 500;
        }

        /* ä¿®æ”¹ï¼šé¢˜ç›®å¡ç‰‡å¤´éƒ¨å¸ƒå±€ */
        .question-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 12px;
        }

        .question-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .question-header-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
                max-width: 100%;
            }
            
            .header {
                padding: 16px 12px;
                margin-bottom: 16px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .header p {
                font-size: 0.85rem;
            }
            
            .controls {
                padding: 12px;
                margin-bottom: 16px;
            }
            
            .control-row {
                flex-direction: row;
                align-items: center;
                gap: 6px;
                padding: 8px;
                flex-wrap: nowrap;
            }
            
            .control-row label {
                min-width: auto;
                margin-bottom: 0;
                font-size: 0.75rem;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            .control-row select, .control-row input {
                width: auto;
                flex: 1;
                padding: 6px 8px;
                font-size: 0.8rem;
                min-width: 0;
            }
            
            .control-row input[type="checkbox"] {
                appearance: none;
                width: 16px;
                height: 16px;
                border: 1px solid #ddd;
                border-radius: 3px;
                background: white;
                cursor: pointer;
                position: relative;
                transition: all 0.2s ease;
                margin: 0;
                flex-shrink: 0;
            }
            
            .control-row .wrong-questions-info {
                font-size: 0.7rem;
                color: #666;
                margin: 0;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            .start-btn {
                width: 100%;
                padding: 12px 20px !important;
                font-size: 1.1rem !important;
            }
            
            .stats {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
            }
            
            .stat-item {
                width: 100%;
                min-width: auto;
                padding: 10px;
            }
            
            .stat-number {
                font-size: 1.3rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .question-card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .question-content {
                font-size: 0.95rem;
                line-height: 1.5;
            }
            
            .answer-input {
                padding: 12px;
                font-size: 1rem;
            }
            
            .choice-option {
                padding: 14px 16px;
                font-size: 0.95rem;
            }
            
            .feedback {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .welcome-screen {
                padding: 20px 12px;
            }
            
            .welcome-screen h2 {
                font-size: 1.2rem;
            }
            
            .welcome-screen p {
                font-size: 0.85rem;
            }
            
            /* æŒ‰é’®ç»„ä¼˜åŒ– */
            .question-header {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .question-header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .question-stats {
                margin-left: 0;
                font-size: 0.85rem;
            }
            
            .question-header-right {
                display: flex;
                gap: 8px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .question-header-right button {
                flex: 1;
                padding: 8px 12px;
                font-size: 0.85rem;
                min-width: auto;
            }
            
            /* é”™é¢˜é›†å’Œç»“æœç•Œé¢ä¼˜åŒ– */
            .result-screen {
                padding: 12px;
            }
            
            .result-header {
                padding: 12px;
            }
            
            .result-header h2 {
                font-size: 1.2rem;
            }
            
            .score-display {
                font-size: 1.8rem;
            }
            
            .result-summary {
                flex-direction: column;
                gap: 8px;
                font-size: 0.9rem;
            }
            
            .result-item {
                padding: 12px;
            }
            
            .result-answers {
                flex-direction: column;
                gap: 8px;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toggle-answer-btn {
            background: #28a745 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            transition: all 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            gap: 5px !important;
            white-space: nowrap !important;
        }
        
        .toggle-answer-btn:hover {
            background: #218838 !important;
        }
        
        .toggle-answer-btn.expanded {
            background: #218838 !important;
        }
        
        .toggle-icon {
            font-size: 0.85rem;
            transition: transform 0.2s ease;
        }
        
        .answer-details {
            transition: all 0.2s ease;
        }
        
        .answer-details.hidden {
            display: none;
        }

        .show-answer-btn {
            background: #28a745 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            transition: all 0.2s ease !important;
            min-width: 80px !important;
            white-space: nowrap !important;
        }
        
        .show-answer-btn:hover {
            background: #218838 !important;
        }
        
        /* äº¤å·æŒ‰é’®æ ·å¼ */
        .submit-btn {
            background: #ff6b35 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            min-width: 80px !important;
            white-space: nowrap !important;
        }
        
        .submit-btn:hover {
            background: #e55a2b !important;
        }
        
        /* è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            background: #6c757d !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            min-width: 80px !important;
            white-space: nowrap !important;
        }
        
        .settings-btn:hover {
            background: #5a6268 !important;
        }
        
        /* é€šç”¨æŒ‰é’®æ–‡å­—ä¸æ¢è¡Œæ ·å¼ */
        button {
            white-space: nowrap !important;
        }
        
        /* ç»“æœå±•ç¤ºç•Œé¢æ ·å¼ */
        .result-screen {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
            border: 1px solid #e8e8e8;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .result-header {
            text-align: center;
            margin-bottom: 16px;
            padding: 16px;
            background: #e8f5e8;
            color: #2d5a2d;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
        }
        
        .result-header h2 {
            margin: 0 0 12px 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .score-display {
            font-size: 2rem;
            font-weight: bold;
            margin: 12px 0;
            color: #28a745;
        }
        
        .result-summary {
            display: flex;
            justify-content: space-around;
            margin: 12px 0;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .result-item {
            background: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .result-item:hover {
            border-color: #28a745;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.1);
        }
        
        .result-item.correct {
            border-left: 3px solid #28a745;
            background: #f8fff9;
        }
        
        .result-item.incorrect {
            border-left: 3px solid #dc3545;
            background: #fff8f8;
        }
        
        .result-question {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .result-answers {
            display: flex;
            gap: 12px;
            margin: 8px 0;
            font-size: 0.85rem;
        }
        
        .user-answer {
            flex: 1;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
        }
        
        .correct-answer {
            flex: 1;
            padding: 8px 10px;
            background: #d4edda;
            border-radius: 4px;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .add-to-wrong-btn {
            background: #dc3545 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            margin-top: 8px !important;
            white-space: nowrap !important;
        }
        
        .add-to-wrong-btn:hover {
            background: #c82333 !important;
        }
        
        .add-to-wrong-btn.added {
            background: #6c757d !important;
            cursor: not-allowed !important;
        }

        /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* ç¡®ä¿æŒ‰é’®æœ‰è¶³å¤Ÿçš„è§¦æ‘¸åŒºåŸŸ */
            button {
                min-height: 36px;
                touch-action: manipulation;
            }
            
            /* è¾“å…¥æ¡†è§¦æ‘¸ä¼˜åŒ– */
            input, select, textarea {
                font-size: 16px !important; /* é˜²æ­¢iOSç¼©æ”¾ */
                touch-action: manipulation;
            }
            
            /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            .choice-option {
                min-height: 48px;
                display: flex;
                align-items: center;
            }
            
            /* ä¼˜åŒ–æ»šåŠ¨ä½“éªŒ */
            .container {
                -webkit-overflow-scrolling: touch;
            }
            
            /* å‡å°‘åŠ¨ç”»ä»¥æé«˜æ€§èƒ½ */
            * {
                transition: none !important;
            }
            
            /* ä¿æŒå¿…è¦çš„åŠ¨ç”» */
            .progress-fill {
                transition: width 0.3s ease !important;
            }
            
            /* ä¼˜åŒ–æ–‡æœ¬é€‰æ‹© */
            .question-content {
                -webkit-user-select: text;
                user-select: text;
            }
            
            /* ä¼˜åŒ–é•¿æŒ‰èœå• */
            .question-content, .answer-input {
                -webkit-touch-callout: default;
            }
            
            /* é”™é¢˜é›†æŒ‰é’®ç»„ä¼˜åŒ– */
            #wrongQuestionsScreen > div:first-child > div:last-child {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            #wrongQuestionsScreen > div:first-child > div:last-child button {
                flex: 1;
                padding: 6px 12px;
                font-size: 0.9rem;
                min-height: 36px;
                white-space: nowrap;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }
            
            .header {
                padding: 12px 8px;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .controls {
                padding: 8px;
            }
            
            .control-row {
                padding: 8px;
            }
            
            .question-card {
                padding: 12px;
            }
            
            .stats {
                padding: 8px;
            }
            
            .stat-item {
                padding: 8px;
            }
            
            .stat-number {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ è‹±è¯­ç»ƒä¹ å¹³å°(4æ®µ)</h1>
            <p>æå‡ä½ çš„è‹±è¯­è¯æ±‡ã€ç¿»è¯‘å’Œè¯­æ³•æŠ€èƒ½</p>
        </div>

        <div class="controls">
            <div class="control-row">
                <label id="practiceTypeLabel">é¢˜å‹é€‰æ‹©</label>
                <select id="practiceType" style="width: 140px;">
                    <option value="all">å…¨éƒ¨ç±»å‹</option>
                    <option value="spelling">å•è¯æ‹¼å†™</option>
                    <option value="phrase_translation">çŸ­è¯­ç¿»è¯‘</option>
                    <option value="multiple_choice">é€‰æ‹©å¡«ç©º</option>
                    <option value="sentence_translation">å¥å­ç¿»è¯‘</option>
                    <option value="paragraph_translation">æ®µè½ç¿»è¯‘</option>
                </select>
            </div>
            
            <div class="control-row">
                <label>å•å…ƒé€‰æ‹©</label>
                <select id="unitSelect" style="width: 140px;">
                    <option value="all">å…¨éƒ¨å•å…ƒ</option>
                    <option value="Unit 9">Unit 9 (Book 1)</option>
                    <option value="Unit 10">Unit 10 (Book 1)</option>
                    <option value="Unit 1">Unit 1 (Book 2)</option>
                    <option value="Unit 2">Unit 2 (Book 2)</option>
                    <option value="Unit 3">Unit 3 (Book 2)</option>
                    <option value="Unit 4">Unit 4 (Book 2)</option>
                    <option value="Unit 5">Unit 5 (Book 2)</option>
                    <option value="Unit 6">Unit 6 (Book 2)</option>
                </select>
            </div>
            
            <div class="control-row">
                <label>é¢˜ç›®æ•°é‡</label>
                <input type="number" id="questionCount" value="10" min="1" max="50">
            </div>
            
            <div class="control-row">
                <label for="wrongQuestionsOnly">ä»…é”™é¢˜</label>
                <input type="checkbox" id="wrongQuestionsOnly">
                <label for="randomQuestions">éšæœºå‡ºé¢˜</label>
                <input type="checkbox" id="randomQuestions">
            </div>
            
            <div class="control-row">
                <button id="startBtn" class="start-btn">å¼€å§‹ç»ƒä¹ </button>
                <button id="wrongQuestionsBtn" class="hidden">é”™é¢˜é›†</button>
            </div>
        </div>

        <div class="practice-area">
            <div id="welcomeScreen" class="welcome-screen">
                <h2>æ¬¢è¿æ¥åˆ°è‹±è¯­ç»ƒä¹ å¹³å°ï¼</h2>
                <p>è¿™é‡Œæœ‰ä¸°å¯Œçš„è‹±è¯­ç»ƒä¹ å†…å®¹ï¼ŒåŒ…æ‹¬å•è¯æ‹¼å†™ã€çŸ­è¯­ç¿»è¯‘ã€é€‰æ‹©é¢˜ç©ºã€å¥å­ç¿»è¯‘å’Œæ®µè½ç¿»è¯‘ç­‰å¤šç§ç±»å‹ã€‚</p>
                <p>è¯·é€‰æ‹©ç»ƒä¹ ç±»å‹å’Œå•å…ƒï¼Œç„¶åç‚¹å‡»"å¼€å§‹ç»ƒä¹ "æŒ‰é’®å¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…ï¼</p>
            </div>

            <div id="practiceScreen" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div id="questionCard" class="question-card">
                    <div class="question-header">
                        <div class="question-header-left">
                            <div style="display: flex; flex-wrap: nowrap; align-items: center; gap: 8px; white-space: nowrap;">
                                <div class="question-type" id="questionType">å•è¯æ‹¼å†™</div>
                                <button id="settingsBtn" class="settings-btn" style="display: none;">è®¾ç½®</button>
                                <button id="submitBtn" class="submit-btn" style="display: none;">äº¤å·</button>
                            </div>
                            <div class="question-stats">
                                <span class="current-total">[<span id="currentQuestion">1</span>/<span id="totalQuestions">10</span>]</span>
                                <span class="correct-count">æ­£ç¡®: <span id="correctCount">0</span></span>
                                <span class="incorrect-count">é”™è¯¯: <span id="incorrectCount">0</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="question-content" id="questionContent">é¢˜ç›®å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                    <div id="choiceOptions" class="choice-options hidden">
                        <!-- é€‰æ‹©é¢˜é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div id="answerInputContainer"></div>
                    <div id="feedback" class="feedback hidden"></div>
                    <div style="display: flex; gap: 8px; margin-top: 12px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                        <button id="prevBtn" class="hidden">ä¸Šä¸€é¢˜</button>
                        <button id="nextBtn" class="hidden">ä¸‹ä¸€é¢˜</button>
                        <button id="showAnswerBtn" class="show-answer-btn" style="display: none;">ç­”æ¡ˆ</button>
                    </div>
                    <div id="feedback" class="feedback hidden" style="margin-top: 8px; text-align: center;"></div>
                </div>
            </div>

            <div id="wrongQuestionsScreen" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333;">é”™é¢˜é›†</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="toggleAllAnswersBtn" style="background: #28a745; color: white; border: none; font-size: 0.85rem; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">å±•å¼€æ‰€æœ‰ç­”æ¡ˆ</button>
                        <button id="deleteAllWrongBtn" style="background: #dc3545; color: white; border: none; font-size: 0.85rem; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">åˆ é™¤æ‰€æœ‰é”™é¢˜</button>
                        <button id="wrongSettingsBtn" style="background: #6c757d; color: white; border: none; font-size: 0.85rem; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">è®¾ç½®</button>
                    </div>
                </div>
                <div id="wrongQuestionsList">
                    <!-- é”™é¢˜åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div id="resultScreen" class="result-screen hidden">
                <div class="result-header">
                    <h2>ç»ƒä¹ å®Œæˆ</h2>
                    <div class="score-display" id="finalScore">0/0</div>
                    <div class="result-summary">
                        <span>æ­£ç¡®: <span id="finalCorrect">0</span></span>
                        <span>é”™è¯¯: <span id="finalIncorrect">0</span></span>
                        <span>å¾—åˆ†ç‡: <span id="finalPercentage">0%</span></span>
                    </div>
                </div>
                <div id="resultList">
                    <!-- ç»“æœåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="backToStartBtn" class="start-btn">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allData = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let wrongQuestions = []; // é”™é¢˜é›†
        let questionStatus = []; // è·Ÿè¸ªæ¯ä¸ªé¢˜ç›®çš„çŠ¶æ€ï¼šnull=æœªä½œç­”, true=æ­£ç¡®, false=é”™è¯¯

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®...');
                const response = await fetch('en4.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allData = await response.json();
                console.log('æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', allData.count || allData.data?.length, 'é“é¢˜ç›®');
                
                // æ•°æ®åŠ è½½å®Œæˆåæ›´æ–°é¢˜å‹æ•°é‡
                renderPracticeTypeOptions();
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                
                // å°è¯•ä½¿ç”¨XMLHttpRequestä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                try {
                    console.log('å°è¯•ä½¿ç”¨XMLHttpRequeståŠ è½½æ•°æ®...');
                    allData = await loadDataWithXHR();
                    console.log('XMLHttpRequeståŠ è½½æˆåŠŸï¼Œå…±', allData.count || allData.data?.length, 'é“é¢˜ç›®');
                    renderPracticeTypeOptions();
                } catch (xhrError) {
                    console.error('XMLHttpRequestä¹Ÿå¤±è´¥äº†:', xhrError);
                    
                    // æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    const errorMessage = `
æ•°æ®åŠ è½½å¤±è´¥ï¼å¯èƒ½çš„åŸå› ï¼š
1. è¯·ç¡®ä¿ en4.json æ–‡ä»¶ä¸ english_practice.html åœ¨åŒä¸€ç›®å½•ä¸‹
2. è¯·ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œï¼ˆå¦‚ Live Serverï¼‰
3. æˆ–è€…ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ en4.json æ–‡ä»¶æ£€æŸ¥å†…å®¹

é”™è¯¯è¯¦æƒ…ï¼š${error.message}
                    `;
                    alert(errorMessage);
                }
            }
        }

        // ä½¿ç”¨XMLHttpRequeståŠ è½½æ•°æ®çš„å¤‡é€‰æ–¹æ¡ˆ
        function loadDataWithXHR() {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'en4.json', true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                const data = JSON.parse(xhr.responseText);
                                resolve(data);
                            } catch (e) {
                                reject(new Error('JSONè§£æå¤±è´¥: ' + e.message));
                            }
                        } else {
                            reject(new Error(`HTTPé”™è¯¯: ${xhr.status}`));
                        }
                    }
                };
                xhr.onerror = function() {
                    reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥'));
                };
                xhr.send();
            });
        }

        // Cookie æ“ä½œå‡½æ•°
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // é”™é¢˜é›†ç®¡ç†
        function loadWrongQuestions() {
            const saved = getCookie('wrongQuestions');
            if (saved) {
                try {
                    wrongQuestions = JSON.parse(saved);
                } catch (e) {
                    wrongQuestions = [];
                }
            }
        }

        function saveWrongQuestions() {
            setCookie('wrongQuestions', JSON.stringify(wrongQuestions), 365); // ä¿å­˜ä¸€å¹´
        }

        function getWrongQuestions() {
            return wrongQuestions || [];
        }

        function updateWrongQuestionsLabel() {
            const checkbox = document.getElementById('wrongQuestionsOnly');
            const wrongQuestionsLabel = checkbox.parentElement.querySelector('label[for="wrongQuestionsOnly"]');
            const practiceTypeLabel = document.getElementById('practiceTypeLabel');
            const wrongQuestionsBtn = document.getElementById('wrongQuestionsBtn');
            const wrongQuestionsCount = getWrongQuestions().length;
            
            // åªåœ¨æœ‰é”™é¢˜æ—¶æ‰æ˜¾ç¤ºé”™é¢˜é›†æŒ‰é’®
            if (wrongQuestionsCount > 0) {
                wrongQuestionsBtn.classList.remove('hidden');
            } else {
                wrongQuestionsBtn.classList.add('hidden');
            }
            
            if (checkbox.checked) {
                // é€‰æ‹©ä»…é”™é¢˜æ—¶ï¼Œé‡æ–°æ¸²æŸ“é¢˜å‹é€‰æ‹©ä¸‹æ‹‰æ¡†ä»¥æ˜¾ç¤ºé”™é¢˜ç±»å‹ä¸ªæ•°
                renderPracticeTypeOptions();
                practiceTypeLabel.textContent = 'é”™é¢˜ç±»å‹';
            } else {
                // ä¸é€‰æ‹©ä»…é”™é¢˜æ—¶ï¼Œé‡æ–°æ¸²æŸ“é¢˜å‹é€‰æ‹©ä¸‹æ‹‰æ¡†ä»¥æ˜¾ç¤ºæ‰€æœ‰é¢˜å‹ä¸ªæ•°
                renderPracticeTypeOptions();
                practiceTypeLabel.textContent = 'é¢˜å‹é€‰æ‹©';
            }
        }

        function resetToDefault() {
            // å¦‚æœå½“å‰åœ¨ç»ƒä¹ çŠ¶æ€ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦ç¡®è®¤é‡ç½®
            if (!document.getElementById('welcomeScreen').classList.contains('hidden')) {
                // å·²ç»åœ¨åˆå§‹çŠ¶æ€ï¼Œåªé‡ç½®é€‰æ‹©é¡¹
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é€‰æ‹©é¡¹åˆ°é»˜è®¤çŠ¶æ€å—ï¼Ÿ')) {
                    resetSelections();
                }
                return;
            }
            
            // åœ¨ç»ƒä¹ çŠ¶æ€ï¼Œè¯¢é—®æ˜¯å¦è¦ç»“æŸå½“å‰ç»ƒä¹ å¹¶é‡ç½®
            if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰ç»ƒä¹ å¹¶é‡ç½®åˆ°åˆå§‹çŠ¶æ€å—ï¼Ÿ\n\nå½“å‰ç»ƒä¹ è¿›åº¦å°†ä¼šä¸¢å¤±ã€‚')) {
                resetSelections();
                resetToInitialState();
            }
        }

        function resetSelections() {
            // é‡ç½®ç»ƒä¹ ç±»å‹ä¸ºå…¨éƒ¨ç±»å‹
            document.getElementById('practiceType').value = 'all';
            
            // é‡ç½®å•å…ƒé€‰æ‹©ä¸ºå…¨éƒ¨å•å…ƒ
            document.getElementById('unitSelect').value = 'all';
            
            // é‡ç½®é¢˜ç›®æ•°é‡ä¸ºé»˜è®¤å€¼
            document.getElementById('questionCount').value = '10';
            
            // é‡ç½®é”™é¢˜é›†å¤é€‰æ¡†ä¸ºæœªé€‰ä¸­
            document.getElementById('wrongQuestionsOnly').checked = false;
            
            // æ›´æ–°é”™é¢˜é›†æ ‡ç­¾
            updateWrongQuestionsLabel();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showResetSuccess();
        }

        function showResetSuccess() {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æˆåŠŸæç¤º
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-size: 0.9rem;
                animation: slideIn 0.3s ease;
            `;
            successDiv.textContent = 'âœ… é‡ç½®æˆåŠŸï¼';
            document.body.appendChild(successDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }, 2000);
        }

        function addToWrongQuestions() {
            const currentQuestion = currentQuestions[currentQuestionIndex];
            if (!currentQuestion) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
            const exists = wrongQuestions.some(q => 
                q.type === currentQuestion.type && 
                q.content.original === currentQuestion.content.original
            );

            if (!exists) {
                wrongQuestions.push({
                    ...currentQuestion,
                    addedTime: new Date().toISOString(),
                    userAnswer: document.getElementById('answerInput').value.trim()
                });
                saveWrongQuestions();
                // æ›´æ–°ç»ƒä¹ ç±»å‹é€‰é¡¹
                renderPracticeTypeOptions();
                // æ›´æ–°é”™é¢˜é›†æ ‡ç­¾
                updateWrongQuestionsLabel();
                alert('å·²åŠ å…¥é”™é¢˜é›†ï¼');
            } else {
                alert('è¯¥é¢˜ç›®å·²åœ¨é”™é¢˜é›†ä¸­ï¼');
            }
        }

        // è‡ªåŠ¨å°†é”™é¢˜åŠ å…¥é”™é¢˜é›†
        function autoAddToWrongQuestions() {
            const currentQuestion = currentQuestions[currentQuestionIndex];
            if (!currentQuestion) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
            const exists = wrongQuestions.some(q => 
                q.type === currentQuestion.type && 
                q.content.original === currentQuestion.content.original
            );

            if (!exists) {
                wrongQuestions.push({
                    ...currentQuestion,
                    addedTime: new Date().toISOString(),
                    userAnswer: document.getElementById('answerInput').value.trim()
                });
                saveWrongQuestions();
                // æ›´æ–°ç»ƒä¹ ç±»å‹é€‰é¡¹
                renderPracticeTypeOptions();
                // æ›´æ–°é”™é¢˜é›†æ ‡ç­¾
                updateWrongQuestionsLabel();
                console.log('é”™é¢˜å·²è‡ªåŠ¨åŠ å…¥é”™é¢˜é›†');
            }
        }

        // äº¤å·æ—¶è‡ªåŠ¨å°†é”™é¢˜åŠ å…¥é”™é¢˜é›†
        function autoAddWrongQuestionToCollection(question, userAnswer) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
            const exists = wrongQuestions.some(q => 
                q.type === question.type && 
                q.content.original === question.content.original
            );

            if (!exists) {
                wrongQuestions.push({
                    ...question,
                    addedTime: new Date().toISOString(),
                    userAnswer: userAnswer
                });
                saveWrongQuestions();
                // æ›´æ–°ç»ƒä¹ ç±»å‹é€‰é¡¹
                renderPracticeTypeOptions();
                // æ›´æ–°é”™é¢˜é›†æ ‡ç­¾
                updateWrongQuestionsLabel();
                console.log('äº¤å·é”™é¢˜å·²è‡ªåŠ¨åŠ å…¥é”™é¢˜é›†');
            }
        }

        function removeFromWrongQuestions(index) {
            wrongQuestions.splice(index, 1);
            saveWrongQuestions();
            renderWrongQuestions(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
            // æ›´æ–°ç»ƒä¹ ç±»å‹é€‰é¡¹
            renderPracticeTypeOptions();
            // æ›´æ–°é”™é¢˜é›†æ ‡ç­¾
            updateWrongQuestionsLabel();
        }

        function renderWrongQuestions() {
            const container = document.getElementById('wrongQuestionsList');
            const toggleAllAnswersBtn = document.getElementById('toggleAllAnswersBtn');
            const deleteAllWrongBtn = document.getElementById('deleteAllWrongBtn');
            
            if (!container) return;

            if (wrongQuestions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— é”™é¢˜</p>';
                // éšè—æŒ‰é’®
                if (toggleAllAnswersBtn) toggleAllAnswersBtn.style.display = 'none';
                if (deleteAllWrongBtn) deleteAllWrongBtn.style.display = 'none';
                return;
            } else {
                // æ˜¾ç¤ºæŒ‰é’®
                if (toggleAllAnswersBtn) toggleAllAnswersBtn.style.display = 'inline-block';
                if (deleteAllWrongBtn) deleteAllWrongBtn.style.display = 'inline-block';
            }

            let html = '';
            wrongQuestions.forEach((question, index) => {
                const typeMap = {
                    'spelling': 'å•è¯æ‹¼å†™',
                    'phrase_translation': 'çŸ­è¯­ç¿»è¯‘',
                    'sentence_translation': 'å¥å­ç¿»è¯‘',
                    'paragraph_translation': 'æ®µè½ç¿»è¯‘',
                    'multiple_choice': 'é€‰æ‹©å¡«ç©º'
                };

                let content = '';
                if (question.type === 'spelling') {
                    content = `è¯·æ‹¼å†™ä»¥ä¸‹ä¸­æ–‡å«ä¹‰å¯¹åº”çš„è‹±æ–‡å•è¯ï¼š<br><strong>${question.content.original}</strong>`;
                } else if (question.type === 'phrase_translation') {
                    content = `è¯·ç¿»è¯‘ä»¥ä¸‹è‹±æ–‡çŸ­è¯­ï¼š<br><strong>${question.content.original}</strong>`;
                } else if (question.type === 'sentence_translation') {
                    content = `è¯·å°†ä»¥ä¸‹ä¸­æ–‡å¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼š<br><strong>${question.content.original}</strong>`;
                } else if (question.type === 'paragraph_translation') {
                    content = `è¯·å°†ä»¥ä¸‹è‹±æ–‡æ®µè½ç¿»è¯‘æˆä¸­æ–‡ï¼š<br><strong>${question.content.original}</strong>`;
                } else if (question.type === 'multiple_choice') {
                    // é€‰æ‹©é¢˜å¯èƒ½æœ‰è‹±æ–‡é¢˜ç›®å’Œä¸­æ–‡ç¿»è¯‘
                    let questionText = '';
                    if (question.content.question) {
                        questionText = question.content.question;
                    } else if (question.content.original) {
                        questionText = question.content.original;
                    } else if (question.content) {
                        questionText = question.content;
                    }
                    
                    content = `<strong>${questionText}</strong>`;
                    
                    // å¦‚æœæœ‰ä¸­æ–‡ç¿»è¯‘ï¼Œä¹Ÿæ˜¾ç¤ºå‡ºæ¥
                    if (question.content.translated) {
                        content += `<br><em style="color: #666; font-size: 0.9rem;">${question.content.translated}</em>`;
                    }
                    
                    // è·å–é€‰é¡¹
                    let options = [];
                    if (question.content.options) {
                        options = question.content.options;
                    } else if (question.options) {
                        options = question.options;
                    } else if (question.answers && question.answers.length > 1) {
                        options = question.answers;
                    }
                    
                    if (options.length > 0) {
                        content += '<br><div style="margin-top: 10px;">';
                        options.forEach((option, optIndex) => {
                            const letter = String.fromCharCode(65 + optIndex);
                            content += `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">${letter}. ${option}</div>`;
                        });
                        content += '</div>';
                    }
                }

                const addedDate = new Date(question.addedTime).toLocaleDateString();

                html += `
                    <div class="question-card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div class="question-type">${typeMap[question.type] || question.type}</div>
                            <div style="display: flex; gap: 5px;">
                                <span style="font-size: 0.75rem; color: #666;">${addedDate}</span>
                                <button onclick="removeFromWrongQuestions(${index})" style="background: #dc3545; color: white; border: none; font-size: 0.85rem; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="question-content">${content}</div>
                        <div style="margin-top: 10px;">
                            <button onclick="toggleAnswer(${index})" class="toggle-answer-btn" id="toggleBtn${index}">
                                <span class="toggle-text">æ˜¾ç¤ºç­”æ¡ˆ</span>
                                <span class="toggle-icon">â–¼</span>
                            </button>
                            <div class="answer-details hidden" id="answerDetails${index}">
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem; margin-top: 8px;">
                                    <strong>ä½ çš„ç­”æ¡ˆï¼š</strong>${question.userAnswer || 'æœªä½œç­”'}<br>
                                    <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>${question.answers.join(', ')}
                                    ${question.analysis ? `<br><strong>è§£æï¼š</strong>${question.analysis}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showWrongQuestions() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('practiceScreen').classList.add('hidden');
            document.getElementById('wrongQuestionsScreen').classList.remove('hidden');
            // éšè—æ§åˆ¶é¢æ¿
            document.querySelector('.controls').classList.add('hidden');
            renderWrongQuestions();
        }

        function backToPractice() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç»ƒä¹ è¿›è¡Œä¸­
            if (currentQuestions && currentQuestions.length > 0) {
                // å¦‚æœæœ‰ç»ƒä¹ è¿›è¡Œä¸­ï¼Œè¿”å›ç»ƒä¹ ç•Œé¢
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('practiceScreen').classList.remove('hidden');
                document.getElementById('wrongQuestionsScreen').classList.add('hidden');
            } else {
                // å¦‚æœæ²¡æœ‰ç»ƒä¹ è¿›è¡Œä¸­ï¼Œè¿”å›æ¬¢è¿ç•Œé¢
                document.getElementById('welcomeScreen').classList.remove('hidden');
                document.getElementById('practiceScreen').classList.add('hidden');
                document.getElementById('wrongQuestionsScreen').classList.add('hidden');
                // æ˜¾ç¤ºæ§åˆ¶é¢æ¿
                document.querySelector('.controls').classList.remove('hidden');
            }
        }

        function toggleAnswer(index) {
            const answerDetails = document.getElementById(`answerDetails${index}`);
            const toggleBtn = document.getElementById(`toggleBtn${index}`);
            const toggleText = toggleBtn.querySelector('.toggle-text');
            const toggleIcon = toggleBtn.querySelector('.toggle-icon');
            
            if (answerDetails.classList.contains('hidden')) {
                // å±•å¼€ç­”æ¡ˆ
                answerDetails.classList.remove('hidden');
                toggleText.textContent = 'éšè—ç­”æ¡ˆ';
                toggleIcon.textContent = 'â–²';
                toggleBtn.classList.add('expanded');
            } else {
                // æ”¶èµ·ç­”æ¡ˆ
                answerDetails.classList.add('hidden');
                toggleText.textContent = 'æ˜¾ç¤ºç­”æ¡ˆ';
                toggleIcon.textContent = 'â–¼';
                toggleBtn.classList.remove('expanded');
            }
        }

        // ç»Ÿè®¡æ¯ç§ç±»å‹çš„é¢˜ç›®æ•°é‡
        function getTypeCounts() {
            if (!allData || !allData.data) return {};
            const counts = {};
            allData.data.forEach(item => {
                counts[item.type] = (counts[item.type] || 0) + 1;
            });
            return counts;
        }

        // åŠ¨æ€æ¸²æŸ“ç»ƒä¹ ç±»å‹ä¸‹æ‹‰èœå•
        function renderPracticeTypeOptions() {
            const typeMap = {
                'spelling': 'å•è¯æ‹¼å†™',
                'phrase_translation': 'çŸ­è¯­ç¿»è¯‘',
                'sentence_translation': 'å¥å­ç¿»è¯‘',
                'paragraph_translation': 'æ®µè½ç¿»è¯‘',
                'multiple_choice': 'é€‰æ‹©å¡«ç©º'
            };
            
            const select = document.getElementById('practiceType');
            if (!select) return;
            select.innerHTML = '';
            
            const wrongQuestionsOnly = document.getElementById('wrongQuestionsOnly').checked;
            
            if (wrongQuestionsOnly) {
                // é€‰æ‹©ä»…é”™é¢˜æ—¶ï¼Œæ˜¾ç¤ºé”™é¢˜ç±»å‹çš„ä¸ªæ•°
                const wrongQuestions = getWrongQuestions();
                const wrongTypeCounts = {};
                
                // ç»Ÿè®¡é”™é¢˜ä¸­å„ç±»å‹çš„æ•°é‡
                wrongQuestions.forEach(q => {
                    wrongTypeCounts[q.type] = (wrongTypeCounts[q.type] || 0) + 1;
                });
                
                // å…¨éƒ¨é”™é¢˜
                select.innerHTML += `<option value="all">å…¨éƒ¨é”™é¢˜ï¼ˆ${wrongQuestions.length}ï¼‰</option>`;
                
                // å„ç±»å‹é”™é¢˜
                ['spelling','phrase_translation','multiple_choice','sentence_translation','paragraph_translation'].forEach(type => {
                    const count = wrongTypeCounts[type] || 0;
                    if (count > 0) { // åªæ˜¾ç¤ºæœ‰é”™é¢˜çš„é¢˜å‹
                        select.innerHTML += `<option value="${type}">${typeMap[type]}ï¼ˆ${count}ï¼‰</option>`;
                    }
                });
            } else {
                // ä¸é€‰æ‹©ä»…é”™é¢˜æ—¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¢˜ç›®çš„ä¸ªæ•°
                const counts = getTypeCounts();
                const allCount = allData && allData.data ? allData.data.length : 0;
                select.innerHTML += `<option value="all">å…¨éƒ¨ç±»å‹ï¼ˆ${allCount}ï¼‰</option>`;
                
                ['spelling','phrase_translation','multiple_choice','sentence_translation','paragraph_translation'].forEach(type => {
                    select.innerHTML += `<option value="${type}">${typeMap[type]}ï¼ˆ${counts[type]||0}ï¼‰</option>`;
                });
            }
        }

        function getRandomQuestions(data, count) {
            // åˆ›å»ºæ•°æ®å‰¯æœ¬å¹¶éšæœºæ‰“ä¹±é¡ºåº
            const shuffled = [...data].sort(() => 0.5 - Math.random());
            // è¿”å›æŒ‡å®šæ•°é‡çš„é¢˜ç›®
            return shuffled.slice(0, count);
        }

        function showQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = currentQuestions.length;
            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // æ§åˆ¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ - å§‹ç»ˆæ˜¾ç¤ºï¼Œä½†æ ¹æ®ä½ç½®è®¾ç½®ç¦ç”¨çŠ¶æ€
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            
            // è®¾ç½®æŒ‰é’®ç¦ç”¨çŠ¶æ€
            if (currentQuestionIndex === 0) {
                prevBtn.disabled = true;
                prevBtn.style.opacity = '0.5';
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.disabled = false;
                prevBtn.style.opacity = '1';
                prevBtn.style.cursor = 'pointer';
            }
            
            if (currentQuestionIndex === currentQuestions.length - 1) {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
            
            // æ˜¾ç¤ºé¢˜ç›®ç±»å‹
            const typeMap = {
                'spelling': 'å•è¯æ‹¼å†™',
                'phrase_translation': 'çŸ­è¯­ç¿»è¯‘',
                'sentence_translation': 'å¥å­ç¿»è¯‘',
                'paragraph_translation': 'æ®µè½ç¿»è¯‘',
                'multiple_choice': 'é€‰æ‹©å¡«ç©º'
            };
            document.getElementById('questionType').textContent = typeMap[question.type] || question.type;
            
            // æ˜¾ç¤ºé¢˜ç›®å†…å®¹
            let content = '';
            if (question.type === 'spelling') {
                content = `è¯·æ‹¼å†™ä»¥ä¸‹ä¸­æ–‡å«ä¹‰å¯¹åº”çš„è‹±æ–‡å•è¯ï¼š<br><strong>${question.content.original}</strong>`;
            } else if (question.type === 'phrase_translation') {
                content = `è¯·ç¿»è¯‘ä»¥ä¸‹è‹±æ–‡çŸ­è¯­ï¼š<br><strong>${question.content.original}</strong>`;
            } else if (question.type === 'sentence_translation') {
                content = `è¯·å°†ä»¥ä¸‹ä¸­æ–‡å¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼š<br><strong>${question.content.original}</strong>`;
            } else if (question.type === 'paragraph_translation') {
                content = `è¯·å°†ä»¥ä¸‹è‹±æ–‡æ®µè½ç¿»è¯‘æˆä¸­æ–‡ï¼š<br><strong>${question.content.original}</strong>`;
            } else if (question.type === 'multiple_choice') {
                // é€‰æ‹©é¢˜å¯èƒ½æœ‰è‹±æ–‡é¢˜ç›®å’Œä¸­æ–‡ç¿»è¯‘
                let questionText = '';
                if (question.content.question) {
                    questionText = question.content.question;
                } else if (question.content.original) {
                    questionText = question.content.original;
                } else if (question.content) {
                    questionText = question.content;
                }
                
                // å¦‚æœæœ‰ä¸­æ–‡ç¿»è¯‘ï¼Œä¹Ÿæ˜¾ç¤ºå‡ºæ¥
                if (question.content.translated) {
                    content = `<strong>${questionText}</strong><br><em style="color: #666; font-size: 0.9rem;">${question.content.translated}</em>`;
                } else {
                    content = `<strong>${questionText}</strong>`;
                }
            }
            document.getElementById('questionContent').innerHTML = content;
            
            // æ¸²æŸ“è¾“å…¥æ¡†
            const answerInputContainer = document.getElementById('answerInputContainer');
            if (question.type === 'sentence_translation' || question.type === 'paragraph_translation') {
                answerInputContainer.innerHTML = '<textarea class="answer-input" id="answerInput" rows="4" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>';
            } else {
                answerInputContainer.innerHTML = '<input type="text" class="answer-input" id="answerInput" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ...">';
            }
            const answerInput = document.getElementById('answerInput');

            // å¤„ç†é€‰æ‹©é¢˜é€‰é¡¹
            const choiceOptions = document.getElementById('choiceOptions');
            if (question.type === 'multiple_choice') {
                // æ˜¾ç¤ºé€‰æ‹©é¢˜é€‰é¡¹
                choiceOptions.classList.remove('hidden');
                answerInput.classList.add('hidden');
                
                let optionsHtml = '';
                // æ£€æŸ¥é¢˜ç›®æ˜¯å¦æœ‰optionså­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨answersä½œä¸ºé€‰é¡¹
                let options = [];
                if (question.content.options) {
                    options = question.content.options;
                } else if (question.options) {
                    options = question.options;
                } else if (question.answers && question.answers.length > 1) {
                    // å¦‚æœanswersæœ‰å¤šä¸ªï¼Œå¯èƒ½æœ¬èº«å°±æ˜¯é€‰é¡¹
                    options = question.answers;
                } else {
                    // å¦‚æœæ²¡æœ‰é€‰é¡¹ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    optionsHtml = '<p style="color: #dc3545;">é¢˜ç›®æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘é€‰é¡¹</p>';
                }
                
                if (options.length > 0) {
                    options.forEach((option, index) => {
                        // è·å–ä¸­æ–‡ç¿»è¯‘
                        let translatedOption = '';
                        if (question.content.options_translated && question.content.options_translated[index]) {
                            translatedOption = ` (${question.content.options_translated[index]})`;
                        }
                        optionsHtml += `<button class="choice-option" data-index="${index}" data-value="${option}">${String.fromCharCode(65 + index)}. ${option}${translatedOption}</button>`;
                    });
                }
                choiceOptions.innerHTML = optionsHtml;
                
                // ä¸ºé€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const optionButtons = choiceOptions.querySelectorAll('.choice-option');
                optionButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                        optionButtons.forEach(btn => btn.classList.remove('selected'));
                        // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                        this.classList.add('selected');
                        // è®¾ç½®ç­”æ¡ˆ
                        document.getElementById('answerInput').value = this.dataset.value;
                        
                        // è‡ªåŠ¨æ£€æŸ¥ç­”æ¡ˆ
                        setTimeout(() => {
                            checkAnswer();
                        }, 100);
                    });
                });
                
                // æ¢å¤ç”¨æˆ·ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
                if (userAnswers[currentQuestionIndex]) {
                    const savedAnswer = userAnswers[currentQuestionIndex];
                    optionButtons.forEach(button => {
                        if (button.dataset.value.toLowerCase() === savedAnswer.toLowerCase()) {
                            button.classList.add('selected');
                        }
                    });
                }
            } else {
                // éšè—é€‰æ‹©é¢˜é€‰é¡¹ï¼Œæ˜¾ç¤ºæ–‡æœ¬è¾“å…¥æ¡†
                choiceOptions.classList.add('hidden');
                answerInput.classList.remove('hidden');
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œåé¦ˆ
            answerInput.value = '';
            document.getElementById('feedback').classList.add('hidden');
            
            // åŠ è½½å·²ä¿å­˜çš„ç­”æ¡ˆ
            if (userAnswers[currentQuestionIndex]) {
                answerInput.value = userAnswers[currentQuestionIndex];
            }
            
            // æ˜¾ç¤ºæ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            showAnswerBtn.style.display = 'block';
            showAnswerBtn.textContent = 'ç­”æ¡ˆ';
            
            // æ˜¾ç¤ºäº¤å·æŒ‰é’®ï¼ˆå½“æœ‰é¢˜ç›®æ—¶ï¼‰
            const submitBtn = document.getElementById('submitBtn');
            if (currentQuestions.length > 0) {
                submitBtn.style.display = 'block';
            } else {
                submitBtn.style.display = 'none';
            }
            
            // æ˜¾ç¤ºè®¾ç½®æŒ‰é’®
            document.getElementById('settingsBtn').style.display = 'block';
            
            // ç»‘å®šå›è½¦æˆ–Ctrl+Enteräº‹ä»¶
            if (question.type === 'sentence_translation' || question.type === 'paragraph_translation') {
                answerInput.onkeydown = function(e) {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        checkAnswer();
                    }
                };
                answerInput.focus();
            } else if (question.type !== 'multiple_choice') {
                answerInput.focus();
                answerInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        checkAnswer();
                    }
                };
            }
        }

        function checkAnswer() {
            const question = currentQuestions[currentQuestionIndex];
            const userAnswer = document.getElementById('answerInput').value.trim();
            const feedback = document.getElementById('feedback');

            let isCorrect = false;
            let correctAnswer = '';

            if (question.type === 'spelling') {
                isCorrect = question.answers.some(answer => 
                    answer.toLowerCase() === userAnswer.toLowerCase()
                );
                correctAnswer = question.answers[0];
            } else if (question.type === 'phrase_translation') {
                isCorrect = question.answers.some(answer => 
                    answer === userAnswer
                );
                correctAnswer = question.answers[0];
            } else if (question.type === 'sentence_translation') {
                isCorrect = question.answers.some(answer => 
                    answer.toLowerCase() === userAnswer.toLowerCase()
                );
                correctAnswer = question.answers[0];
            } else if (question.type === 'paragraph_translation') {
                isCorrect = question.answers.some(answer => 
                    answer === userAnswer
                );
                correctAnswer = question.answers[0];
            } else if (question.type === 'multiple_choice') {
                console.log('é€‰æ‹©é¢˜ç­”æ¡ˆæ£€æŸ¥:');
                console.log('ç”¨æˆ·ç­”æ¡ˆ:', userAnswer);
                console.log('æ­£ç¡®ç­”æ¡ˆ:', question.answers);
                console.log('ç”¨æˆ·ç­”æ¡ˆ(å°å†™):', userAnswer.toLowerCase());
                console.log('æ­£ç¡®ç­”æ¡ˆ(å°å†™):', question.answers.map(a => a.toLowerCase()));
                
                // è·å–é€‰é¡¹
                let options = [];
                if (question.content.options) {
                    options = question.content.options;
                } else if (question.options) {
                    options = question.options;
                }
                
                // æ£€æŸ¥ç­”æ¡ˆï¼šæ”¯æŒå­—æ¯ç­”æ¡ˆï¼ˆAã€Bã€Cã€Dï¼‰å’Œå†…å®¹ç­”æ¡ˆ
                isCorrect = question.answers.some(answer => {
                    const answerLower = answer.toLowerCase();
                    const userAnswerLower = userAnswer.toLowerCase();
                    
                    // ç›´æ¥æ¯”è¾ƒç­”æ¡ˆ
                    if (answerLower === userAnswerLower) {
                        return true;
                    }
                    
                    // å¦‚æœç­”æ¡ˆæ˜¯å­—æ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å†…å®¹
                    if (answerLower.length === 1 && 'abcd'.includes(answerLower)) {
                        const optionIndex = answerLower.charCodeAt(0) - 97; // a=0, b=1, c=2, d=3
                        if (options[optionIndex] && options[optionIndex].toLowerCase() === userAnswerLower) {
                            return true;
                        }
                    }
                    
                    // å¦‚æœç”¨æˆ·ç­”æ¡ˆæ˜¯å­—æ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å†…å®¹
                    if (userAnswerLower.length === 1 && 'abcd'.includes(userAnswerLower)) {
                        const optionIndex = userAnswerLower.charCodeAt(0) - 97; // a=0, b=1, c=2, d=3
                        if (options[optionIndex] && options[optionIndex].toLowerCase() === answerLower) {
                            return true;
                        }
                    }
                    
                    return false;
                });
                
                correctAnswer = question.answers[0];
                
                console.log('ç­”æ¡ˆæ˜¯å¦æ­£ç¡®:', isCorrect);
                
                // æ›´æ–°é€‰é¡¹çš„æ˜¾ç¤ºçŠ¶æ€
                const optionButtons = document.querySelectorAll('.choice-option');
                optionButtons.forEach(button => {
                    const optionValue = button.dataset.value;
                    const optionIndex = button.dataset.index;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£ç¡®ç­”æ¡ˆ
                    let isCorrectOption = false;
                    question.answers.forEach(answer => {
                        const answerLower = answer.toLowerCase();
                        const optionValueLower = optionValue.toLowerCase();
                        
                        // ç›´æ¥æ¯”è¾ƒ
                        if (answerLower === optionValueLower) {
                            isCorrectOption = true;
                        }
                        
                        // å¦‚æœç­”æ¡ˆæ˜¯å­—æ¯ï¼Œæ£€æŸ¥ç´¢å¼•
                        if (answerLower.length === 1 && 'abcd'.includes(answerLower)) {
                            const expectedIndex = answerLower.charCodeAt(0) - 97;
                            if (parseInt(optionIndex) === expectedIndex) {
                                isCorrectOption = true;
                            }
                        }
                    });
                    
                    if (isCorrectOption) {
                        button.classList.add('correct');
                    } else if (optionValue.toLowerCase() === userAnswer.toLowerCase() && !isCorrect) {
                        button.classList.add('incorrect');
                    }
                    // ä¿ç•™ç”¨æˆ·çš„é€‰æ‹©çŠ¶æ€ï¼Œä¸æ¸…é™¤selectedç±»
                });
            }

            // å¤„ç†é¢˜ç›®çŠ¶æ€å˜åŒ–
            const previousStatus = questionStatus[currentQuestionIndex];
            
            if (isCorrect) {
                // å¦‚æœä¹‹å‰æ˜¯é”™è¯¯çŠ¶æ€ï¼Œéœ€è¦å‡å°‘é”™è¯¯æ•°
                if (previousStatus === false) {
                    incorrectCount--;
                }
                // å¦‚æœä¹‹å‰ä¸æ˜¯æ­£ç¡®çŠ¶æ€ï¼Œå¢åŠ æ­£ç¡®æ•°
                if (previousStatus !== true) {
                    correctCount++;
                }
                questionStatus[currentQuestionIndex] = true;
                
                feedback.className = 'feedback correct';
                feedback.textContent = 'âœ… å›ç­”æ­£ç¡®ï¼';
                
                // é€‰æ‹©é¢˜ç­”å¯¹åï¼Œå»¶è¿Ÿ1ç§’è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
                if (question.type === 'multiple_choice') {
                    setTimeout(() => {
                        if (currentQuestionIndex < currentQuestions.length - 1) {
                            nextQuestion();
                        }
                        // å¦‚æœæ˜¯æœ€åä¸€é¢˜ï¼Œä¸è‡ªåŠ¨è·³è½¬ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨äº¤å·
                    }, 1000);
                }
            } else {
                // å¦‚æœä¹‹å‰æ˜¯æ­£ç¡®çŠ¶æ€ï¼Œéœ€è¦å‡å°‘æ­£ç¡®æ•°
                if (previousStatus === true) {
                    correctCount--;
                }
                // å¦‚æœä¹‹å‰ä¸æ˜¯é”™è¯¯çŠ¶æ€ï¼Œå¢åŠ é”™è¯¯æ•°
                if (previousStatus !== false) {
                    incorrectCount++;
                }
                questionStatus[currentQuestionIndex] = false;
                
                feedback.className = 'feedback incorrect';
                
                // å¯¹äºé€‰æ‹©é¢˜ï¼Œæ˜¾ç¤ºæ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
                if (question.type === 'multiple_choice') {
                    let options = [];
                    if (question.content.options) {
                        options = question.content.options;
                    } else if (question.options) {
                        options = question.options;
                    }
                    
                    // æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„ç´¢å¼•
                    let correctIndex = -1;
                    if (options.length > 0) {
                        // å¦‚æœç­”æ¡ˆæ˜¯å­—æ¯ï¼Œç›´æ¥ä½¿ç”¨
                        if (question.answers[0].length === 1 && 'ABCD'.includes(question.answers[0].toUpperCase())) {
                            correctIndex = question.answers[0].toUpperCase().charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
                        } else {
                            // å¦‚æœç­”æ¡ˆæ˜¯å†…å®¹ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                            correctIndex = options.findIndex(option => 
                                question.answers.some(answer => answer.toLowerCase() === option.toLowerCase())
                            );
                        }
                    }
                    
                    if (correctIndex >= 0) {
                        const correctLetter = String.fromCharCode(65 + correctIndex);
                        const correctContent = options[correctIndex] || question.answers.join(', ');
                        feedback.textContent = `âŒ å›ç­”é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆï¼š${correctLetter}. ${correctContent}`;
                    } else {
                        feedback.textContent = `âŒ å›ç­”é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆï¼š${correctAnswer}`;
                    }
                } else {
                    // å•è¯æ‹¼å†™é¢˜å‹ï¼Œæ˜¾ç¤ºè§£æå†…å®¹
                    let analysis = question.analysis || 'æš‚æ— è§£æ';
                    feedback.innerHTML = `âŒ å›ç­”é”™è¯¯ã€‚<br>æ­£ç¡®ç­”æ¡ˆï¼š<span style="color:#007aff;font-weight:bold;">${correctAnswer}</span><br><br><strong>è§£æï¼š</strong><br>${analysis}`;
                }
                
                // è‡ªåŠ¨å°†é”™é¢˜åŠ å…¥é”™é¢˜é›†
                autoAddToWrongQuestions();
            }

            feedback.classList.remove('hidden');
            updateStats();

            // æ›´æ–°æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®çš„æ–‡æœ¬
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            if (showAnswerBtn) {
                showAnswerBtn.textContent = 'éšè—';
            }

            // æ ¹æ®å½“å‰é¢˜ç›®ä½ç½®æ˜¾ç¤ºä¸Šä¸€é¢˜å’Œä¸‹ä¸€é¢˜æŒ‰é’®
            if (currentQuestionIndex > 0) {
                document.getElementById('prevBtn').classList.remove('hidden');
            }
            if (currentQuestionIndex < currentQuestions.length - 1) {
                document.getElementById('nextBtn').classList.remove('hidden');
            }
        }

        // ä¿®å¤è¢«æˆªæ–­çš„å•è¯
        function fixTruncatedWords(analysis, correctAnswers) {
            if (!analysis || !correctAnswers || correctAnswers.length === 0) {
                return analysis;
            }
            
            let fixedAnalysis = analysis;
            
            // ä¿®å¤å¸¸è§çš„æˆªæ–­æ¨¡å¼
            correctAnswers.forEach(answer => {
                // æŸ¥æ‰¾è¢«æˆªæ–­çš„å•è¯æ¨¡å¼
                const patterns = [
                    new RegExp(`è‹±æ–‡å•è¯\\s+([a-zA-Z]+)\\s+è¡¨ç¤º.*${answer}`, 'g'),
                    new RegExp(`å•è¯\\s+([a-zA-Z]+)\\s+è¡¨ç¤º.*${answer}`, 'g'),
                    new RegExp(`([a-zA-Z]+)\\s+è¡¨ç¤º.*${answer}`, 'g'),
                    new RegExp(`è‹±æ–‡å•è¯\\s+([a-zA-Z]+)\\s+è¡¨ç¤º`, 'g'),
                    new RegExp(`å•è¯\\s+([a-zA-Z]+)\\s+è¡¨ç¤º`, 'g')
                ];
                
                patterns.forEach(pattern => {
                    const match = fixedAnalysis.match(pattern);
                    if (match && match[1] !== answer && match[1].length < answer.length) {
                        // æ›¿æ¢è¢«æˆªæ–­çš„å•è¯ä¸ºå®Œæ•´å•è¯
                        fixedAnalysis = fixedAnalysis.replace(match[1], answer);
                    }
                });
                
                // å¦‚æœè§£æä¸­æ²¡æœ‰æ‰¾åˆ°æ­£ç¡®çš„å•è¯ï¼Œåœ¨å¼€å¤´æ·»åŠ 
                if (!fixedAnalysis.includes(answer) && !fixedAnalysis.includes('è‹±æ–‡å•è¯')) {
                    fixedAnalysis = `è‹±æ–‡å•è¯ ${answer} è¡¨ç¤º"${fixedAnalysis}"`;
                }
            });
            
            return fixedAnalysis;
        }

        function showAnswer() {
            const question = currentQuestions[currentQuestionIndex];
            const feedback = document.getElementById('feedback');
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            
            if (!question) {
                console.error('æ²¡æœ‰æ‰¾åˆ°å½“å‰é¢˜ç›®');
                return;
            }
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ˜¾ç¤ºç­”æ¡ˆ
            const isAnswerVisible = !feedback.classList.contains('hidden');
            
            if (isAnswerVisible) {
                // å¦‚æœç­”æ¡ˆå·²æ˜¾ç¤ºï¼Œåˆ™éšè—ç­”æ¡ˆ
                feedback.classList.add('hidden');
                showAnswerBtn.textContent = 'ç­”æ¡ˆ';
                return;
            }
            
            // å¦‚æœç­”æ¡ˆæœªæ˜¾ç¤ºï¼Œåˆ™æ˜¾ç¤ºç­”æ¡ˆ
            // æ„å»ºæ›´å¥½çš„ç­”æ¡ˆæ˜¾ç¤º
            let answerDisplay = `<strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong><br>`;
            
            if (question.type === 'spelling') {
                // å¯¹äºå•è¯æ‹¼å†™ï¼Œæ˜¾ç¤ºå®Œæ•´çš„è‹±æ–‡å•è¯
                answerDisplay += `<span style="font-size: 1.2em; color: #667eea; font-weight: bold;">${question.answers.join(', ')}</span>`;
                // æ˜¾ç¤ºè§£æå†…å®¹
                answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                answerDisplay += question.analysis ? question.analysis : 'æš‚æ— è§£æ';
            } else if (question.type === 'multiple_choice') {
                // å¯¹äºé€‰æ‹©é¢˜ï¼Œæ˜¾ç¤ºé€‰é¡¹å­—æ¯å’Œå•è¯
                let correctIndex = -1;
                let options = [];
                
                // è·å–é€‰é¡¹
                if (question.content.options) {
                    options = question.content.options;
                } else if (question.options) {
                    options = question.options;
                } else if (question.answers && question.answers.length > 1) {
                    options = question.answers;
                }
                
                // æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„ç´¢å¼•
                if (options.length > 0) {
                    // å¦‚æœç­”æ¡ˆæ˜¯å­—æ¯ï¼Œç›´æ¥ä½¿ç”¨
                    if (question.answers[0].length === 1 && 'ABCD'.includes(question.answers[0].toUpperCase())) {
                        correctIndex = question.answers[0].toUpperCase().charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
                    } else {
                        // å¦‚æœç­”æ¡ˆæ˜¯å†…å®¹ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                        correctIndex = options.findIndex(option => 
                            question.answers.some(answer => answer.toLowerCase() === option.toLowerCase())
                        );
                    }
                }
                
                if (correctIndex >= 0) {
                    const correctLetter = String.fromCharCode(65 + correctIndex);
                    const correctContent = options[correctIndex] || question.answers.join(', ');
                    answerDisplay += `<span style="font-size: 1.2em; color: #667eea; font-weight: bold;">${correctLetter}. ${correctContent}</span>`;
                    
                    // æ›´æ–°é€‰é¡¹æ˜¾ç¤ºçŠ¶æ€
                    const optionButtons = document.querySelectorAll('.choice-option');
                    optionButtons.forEach((button, index) => {
                        if (index === correctIndex) {
                            button.classList.add('correct');
                        }
                        // ä¿ç•™ç”¨æˆ·çš„é€‰æ‹©çŠ¶æ€ï¼Œä¸æ¸…é™¤selectedç±»
                    });
                } else {
                    answerDisplay += `<span style="font-size: 1.2em; color: #667eea; font-weight: bold;">${question.answers.join(', ')}</span>`;
                }
                
                // å¦‚æœæœ‰è§£æï¼Œæ·»åŠ åˆ°ç­”æ¡ˆæ˜¾ç¤ºä¸­
                if (question.explanation) {
                    answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                    answerDisplay += question.explanation;
                } else if (question.analysis) {
                    answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                    answerDisplay += question.analysis;
                } else {
                    answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                    answerDisplay += 'æš‚æ— è§£æ';
                }
            } else if (question.type === 'phrase_translation') {
                // å¯¹äºçŸ­è¯­ç¿»è¯‘ï¼Œæ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘
                answerDisplay += `<span style="font-size: 1.2em; color: #667eea; font-weight: bold;">${question.answers.join(', ')}</span>`;
                answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                answerDisplay += question.analysis ? question.analysis : 'æš‚æ— è§£æ';
            } else if (question.type === 'sentence_translation') {
                // å¯¹äºå¥å­ç¿»è¯‘ï¼Œæ˜¾ç¤ºè‹±æ–‡ç¿»è¯‘
                answerDisplay += `<span style="font-size: 1.2em; color: #667eea; font-weight: bold;">${question.answers.join(', ')}</span>`;
                answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                answerDisplay += question.analysis ? question.analysis : 'æš‚æ— è§£æ';
            } else if (question.type === 'paragraph_translation') {
                // å¯¹äºæ®µè½ç¿»è¯‘ï¼Œæ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘
                answerDisplay += `<span style="font-size: 1.2em; color: #667eea; font-weight: bold;">${question.answers.join(', ')}</span>`;
                answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                answerDisplay += question.analysis ? question.analysis : 'æš‚æ— è§£æ';
            } else {
                answerDisplay += `<span style="font-size: 1.2em; color: #667eea; font-weight: bold;">${question.answers.join(', ')}</span>`;
                answerDisplay += '<br><br><strong>è§£æï¼š</strong><br>';
                
                // å¤„ç†è§£æå†…å®¹ï¼Œä¿®å¤è¢«æˆªæ–­çš„å•è¯
                let analysis = question.analysis || 'æš‚æ— è§£æ';
                
                // ä½¿ç”¨ä¿®å¤å‡½æ•°å¤„ç†è¢«æˆªæ–­çš„å•è¯
                analysis = fixTruncatedWords(analysis, question.answers);
                answerDisplay += analysis;
            }
            
            feedback.className = 'feedback correct';
            feedback.innerHTML = answerDisplay;
            feedback.classList.remove('hidden');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            showAnswerBtn.textContent = 'éšè—';
        }

        function prevQuestion() {
            // ä¿å­˜å½“å‰ç­”æ¡ˆ
            saveCurrentAnswer();
            
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function nextQuestion() {
            // ä¿å­˜å½“å‰ç­”æ¡ˆ
            saveCurrentAnswer();
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= currentQuestions.length) {
                // ç»ƒä¹ å®Œæˆ
                showResults();
                return;
            }

            showQuestion();
        }

        function showResults() {
            const accuracy = ((correctCount / currentQuestions.length) * 100).toFixed(1);
            
            document.getElementById('practiceScreen').innerHTML = `
                <div class="welcome-screen">
                    <h2>ğŸ‰ ç»ƒä¹ å®Œæˆï¼</h2>
                    <div style="margin: 30px 0;">
                        <div style="font-size: 3rem; color: #667eea; margin-bottom: 10px;">${accuracy}%</div>
                        <div style="color: #666; margin-bottom: 20px;">æ­£ç¡®ç‡</div>
                        <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                            <div>
                                <div style="font-size: 1.5rem; color: #28a745;">${correctCount}</div>
                                <div style="color: #666;">æ­£ç¡®</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; color: #dc3545;">${incorrectCount}</div>
                                <div style="color: #666;">é”™è¯¯</div>
                            </div>
                        </div>
                    </div>
                    <p style="color: #666; text-align: center;">ç‚¹å‡»ä¸Šæ–¹çš„"å¼€å§‹ç»ƒä¹ "æŒ‰é’®å¯ä»¥é‡æ–°å¼€å§‹ç»ƒä¹ </p>
                </div>
            `;
            
            // ç¡®ä¿å¼€å§‹ç»ƒä¹ æŒ‰é’®å¯è§
            document.getElementById('startBtn').classList.remove('hidden');
        }

        function resetToInitialState() {
            // é‡ç½®å…¨å±€å˜é‡
            currentQuestions = [];
            currentQuestionIndex = 0;
            correctCount = 0;
            incorrectCount = 0;
            
            // é‡ç½®UIçŠ¶æ€
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('practiceScreen').classList.add('hidden');
            document.getElementById('wrongQuestionsScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            
            // æ˜¾ç¤ºæ§åˆ¶é¢æ¿
            document.querySelector('.controls').classList.remove('hidden');
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('wrongQuestionsBtn').classList.add('hidden');
        }

        // äº¤å·åŠŸèƒ½ç›¸å…³å˜é‡
        let userAnswers = []; // å­˜å‚¨ç”¨æˆ·ç­”æ¡ˆ
        let questionResults = []; // å­˜å‚¨é¢˜ç›®ç»“æœ

        // åˆå§‹åŒ–ç”¨æˆ·ç­”æ¡ˆæ•°ç»„
        function initializeUserAnswers() {
            userAnswers = new Array(currentQuestions.length).fill('');
        }

        // ä¿å­˜å½“å‰é¢˜ç›®çš„ç­”æ¡ˆ
        function saveCurrentAnswer() {
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                userAnswers[currentQuestionIndex] = answerInput.value.trim();
            }
        }

        // äº¤å·åŠŸèƒ½
        function submitExam() {
            // ä¿å­˜å½“å‰é¢˜ç›®çš„ç­”æ¡ˆ
            saveCurrentAnswer();
            
            // æ¸…ç†é€‰æ‹©é¢˜é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            const optionButtons = document.querySelectorAll('.choice-option');
            optionButtons.forEach(button => {
                button.classList.remove('selected');
            });
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¢˜ç›®éƒ½å·²ä½œç­”
            const unansweredCount = userAnswers.filter(answer => !answer).length;
            if (unansweredCount > 0) {
                const confirmSubmit = confirm(`è¿˜æœ‰ ${unansweredCount} é“é¢˜ç›®æœªä½œç­”ï¼Œç¡®å®šè¦äº¤å·å—ï¼Ÿ`);
                if (!confirmSubmit) {
                    return;
                }
            }
            
            // æ£€æŸ¥æ‰€æœ‰ç­”æ¡ˆ
            questionResults = [];
            for (let i = 0; i < currentQuestions.length; i++) {
                const question = currentQuestions[i];
                const userAnswer = userAnswers[i] || '';
                
                // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
                const isCorrect = checkAnswerCorrect(question, userAnswer);
                questionResults.push({
                    question: question,
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    correctAnswers: question.answers
                });
                
                // å¦‚æœç­”æ¡ˆé”™è¯¯ï¼Œè‡ªåŠ¨åŠ å…¥é”™é¢˜é›†
                if (!isCorrect) {
                    autoAddWrongQuestionToCollection(question, userAnswer);
                }
            }
            
            // è®¡ç®—æ€»åˆ†
            const totalCorrect = questionResults.filter(result => result.isCorrect).length;
            const totalQuestions = currentQuestions.length;
            const score = totalCorrect;
            const percentage = ((score / totalQuestions) * 100).toFixed(1);
            
            // æ˜¾ç¤ºç»“æœç•Œé¢
            showResultScreen(score, totalQuestions, percentage, questionResults);
        }

        // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
        function checkAnswerCorrect(question, userAnswer) {
            if (!userAnswer) return false;
            
            if (question.type === 'spelling') {
                return question.answers.some(answer => 
                    answer.toLowerCase() === userAnswer.toLowerCase()
                );
            } else if (question.type === 'phrase_translation') {
                return question.answers.some(answer => 
                    answer === userAnswer
                );
            } else if (question.type === 'sentence_translation') {
                return question.answers.some(answer => 
                    answer.toLowerCase() === userAnswer.toLowerCase()
                );
            } else if (question.type === 'paragraph_translation') {
                return question.answers.some(answer => 
                    answer === userAnswer
                );
            } else if (question.type === 'multiple_choice') {
                // è·å–é€‰é¡¹
                let options = [];
                if (question.content.options) {
                    options = question.content.options;
                } else if (question.options) {
                    options = question.options;
                }
                
                // æ£€æŸ¥ç­”æ¡ˆï¼šæ”¯æŒå­—æ¯ç­”æ¡ˆï¼ˆAã€Bã€Cã€Dï¼‰å’Œå†…å®¹ç­”æ¡ˆ
                return question.answers.some(answer => {
                    const answerLower = answer.toLowerCase();
                    const userAnswerLower = userAnswer.toLowerCase();
                    
                    // ç›´æ¥æ¯”è¾ƒç­”æ¡ˆ
                    if (answerLower === userAnswerLower) {
                        return true;
                    }
                    
                    // å¦‚æœç­”æ¡ˆæ˜¯å­—æ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å†…å®¹
                    if (answerLower.length === 1 && 'abcd'.includes(answerLower)) {
                        const optionIndex = answerLower.charCodeAt(0) - 97; // a=0, b=1, c=2, d=3
                        if (options[optionIndex] && options[optionIndex].toLowerCase() === userAnswerLower) {
                            return true;
                        }
                    }
                    
                    // å¦‚æœç”¨æˆ·ç­”æ¡ˆæ˜¯å­—æ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å†…å®¹
                    if (userAnswerLower.length === 1 && 'abcd'.includes(userAnswerLower)) {
                        const optionIndex = userAnswerLower.charCodeAt(0) - 97; // a=0, b=1, c=2, d=3
                        if (options[optionIndex] && options[optionIndex].toLowerCase() === answerLower) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            }
            
            return false;
        }

        // æ˜¾ç¤ºç»“æœç•Œé¢
        function showResultScreen(score, totalQuestions, percentage, results) {
            // æ›´æ–°ç»“æœç»Ÿè®¡
            document.getElementById('finalScore').textContent = `${score}/${totalQuestions}`;
            document.getElementById('finalCorrect').textContent = score;
            document.getElementById('finalIncorrect').textContent = totalQuestions - score;
            document.getElementById('finalPercentage').textContent = `${percentage}%`;
            
            // æ¸²æŸ“ç»“æœåˆ—è¡¨
            renderResultList(results);
            
            // åˆ‡æ¢ç•Œé¢
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('practiceScreen').classList.add('hidden');
            document.getElementById('wrongQuestionsScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
        }

        // æ¸²æŸ“ç»“æœåˆ—è¡¨
        function renderResultList(results) {
            const resultList = document.getElementById('resultList');
            const typeMap = {
                'spelling': 'å•è¯æ‹¼å†™',
                'phrase_translation': 'çŸ­è¯­ç¿»è¯‘',
                'sentence_translation': 'å¥å­ç¿»è¯‘',
                'paragraph_translation': 'æ®µè½ç¿»è¯‘',
                'multiple_choice': 'é€‰æ‹©å¡«ç©º'
            };
            
            let html = '';
            results.forEach((result, index) => {
                const question = result.question;
                const isCorrect = result.isCorrect;
                
                // æ„å»ºé¢˜ç›®å†…å®¹
                let questionContent = '';
                if (question.type === 'spelling') {
                    questionContent = question.content.original;
                } else if (question.type === 'phrase_translation') {
                    questionContent = question.content.original;
                } else if (question.type === 'sentence_translation') {
                    questionContent = question.content.original;
                } else if (question.type === 'paragraph_translation') {
                    questionContent = question.content.original;
                } else if (question.type === 'multiple_choice') {
                    let questionText = '';
                    if (question.content.question) {
                        questionText = question.content.question;
                    } else if (question.content.original) {
                        questionText = question.content.original;
                    } else if (question.content) {
                        questionText = question.content;
                    }
                    questionContent = questionText;
                }
                
                html += `
                    <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <div class="result-question">
                            <span style="background: ${isCorrect ? '#28a745' : '#dc3545'}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85rem; margin-right: 8px;">${isCorrect ? 'âœ“' : 'âœ—'}</span>
                            <span style="background: #007aff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85rem; margin-right: 8px;">${typeMap[question.type] || question.type}</span>
                            ç¬¬${index + 1}é¢˜
                        </div>
                        <div style="margin: 8px 0; font-size: 0.9rem; color: #666;">${questionContent}</div>
                        <div class="result-answers">
                            <div class="user-answer">
                                <strong>ä½ çš„ç­”æ¡ˆï¼š</strong> ${result.userAnswer || 'æœªä½œç­”'}
                            </div>
                            <div class="correct-answer">
                                <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${result.correctAnswers.join(', ')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultList.innerHTML = html;
        }

        // å°†ç»“æœä¸­çš„é”™é¢˜æ·»åŠ åˆ°é”™é¢˜é›†
        function addResultToWrongQuestions(resultIndex) {
            const result = questionResults[resultIndex];
            if (!result) return;
            
            const question = result.question;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
            const exists = wrongQuestions.some(q => 
                q.type === question.type && 
                q.content.original === question.content.original
            );

            if (!exists) {
                wrongQuestions.push({
                    ...question,
                    addedTime: new Date().toISOString(),
                    userAnswer: result.userAnswer
                });
                saveWrongQuestions();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const button = event.target;
                button.textContent = 'å·²æ·»åŠ ';
                button.classList.add('added');
                button.disabled = true;
                
                // æ›´æ–°é”™é¢˜é›†æ ‡ç­¾
                updateWrongQuestionsLabel();
                alert('å·²åŠ å…¥é”™é¢˜é›†ï¼');
            } else {
                alert('è¯¥é¢˜ç›®å·²åœ¨é”™é¢˜é›†ä¸­ï¼');
            }
        }

        // è¿”å›å¼€å§‹ç•Œé¢
        function backToStart() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('practiceScreen').classList.add('hidden');
            document.getElementById('wrongQuestionsScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            
            // æ˜¾ç¤ºæ§åˆ¶é¢æ¿
            document.querySelector('.controls').classList.remove('hidden');
        }

        function resetButtonStates() {
            // é‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').classList.remove('hidden');
        }

        function updateStats() {
            const correctElement = document.getElementById('correctCount');
            const incorrectElement = document.getElementById('incorrectCount');
            
            correctElement.textContent = correctCount;
            correctElement.style.color = '#28a745'; // ç»¿è‰²
            
            incorrectElement.textContent = incorrectCount;
            incorrectElement.style.color = '#dc3545'; // çº¢è‰²
        }

        function toggleAllAnswers() {
            const toggleAllBtn = document.getElementById('toggleAllAnswersBtn');
            const answerDetails = document.querySelectorAll('.answer-details');
            const toggleBtns = document.querySelectorAll('.toggle-answer-btn');
            
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            const isAllExpanded = Array.from(answerDetails).every(details => !details.classList.contains('hidden'));
            
            answerDetails.forEach(details => {
                if (isAllExpanded) {
                    // å½“å‰å…¨éƒ¨å±•å¼€ï¼Œåˆ™å…¨éƒ¨æ”¶èµ·
                    details.classList.add('hidden');
                } else {
                    // å½“å‰éƒ¨åˆ†æ”¶èµ·ï¼Œåˆ™å…¨éƒ¨å±•å¼€
                    details.classList.remove('hidden');
                }
            });
            
            toggleBtns.forEach(btn => {
                const toggleText = btn.querySelector('.toggle-text');
                const toggleIcon = btn.querySelector('.toggle-icon');
                
                if (isAllExpanded) {
                    // å…¨éƒ¨æ”¶èµ·
                    toggleText.textContent = 'æ˜¾ç¤ºç­”æ¡ˆ';
                    toggleIcon.textContent = 'â–¼';
                    btn.classList.remove('expanded');
                } else {
                    // å…¨éƒ¨å±•å¼€
                    toggleText.textContent = 'éšè—ç­”æ¡ˆ';
                    toggleIcon.textContent = 'â–²';
                    btn.classList.add('expanded');
                }
            });
            
            // æ›´æ–°ä¸€é”®æŒ‰é’®æ–‡æœ¬
            toggleAllBtn.textContent = isAllExpanded ? 'å±•å¼€æ‰€æœ‰ç­”æ¡ˆ' : 'æ”¶èµ·æ‰€æœ‰ç­”æ¡ˆ';
        }

        // æ˜¾ç¤ºè®¾ç½®ç•Œé¢
        function showSettings() {
            // æ˜¾ç¤ºæ§åˆ¶é¢æ¿
            document.querySelector('.controls').classList.remove('hidden');
            // éšè—ç»ƒä¹ ç•Œé¢
            document.getElementById('practiceScreen').classList.add('hidden');
            // éšè—å…¶ä»–ç•Œé¢
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('wrongQuestionsScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
        }

        // åˆ é™¤æ‰€æœ‰é”™é¢˜
        function deleteAllWrongQuestions() {
            if (wrongQuestions.length === 0) {
                alert('é”™é¢˜é›†å·²ç»æ˜¯ç©ºçš„ï¼');
                return;
            }
            
            const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ ${wrongQuestions.length} é“é”™é¢˜å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
            if (confirmDelete) {
                wrongQuestions.length = 0; // æ¸…ç©ºæ•°ç»„
                saveWrongQuestions();
                renderWrongQuestions(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
                // æ›´æ–°ç»ƒä¹ ç±»å‹é€‰é¡¹
                renderPracticeTypeOptions();
                // æ›´æ–°é”™é¢˜é›†æ ‡ç­¾
                updateWrongQuestionsLabel();
                alert('æ‰€æœ‰é”™é¢˜å·²åˆ é™¤ï¼');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.addEventListener('load', function() {
            // åŠ è½½æœ¬åœ°æ•°æ®
            loadData();
            // åŠ è½½é”™é¢˜é›†
            loadWrongQuestions();
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            // æ¸²æŸ“ç»ƒä¹ ç±»å‹é€‰é¡¹
            renderPracticeTypeOptions();
            // åˆå§‹åŒ–é”™é¢˜é›†æ ‡ç­¾
            updateWrongQuestionsLabel();
        });

        function setupEventListeners() {
            // ä¸ºæ§åˆ¶é¢æ¿ä¸­çš„å¼€å§‹ç»ƒä¹ æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.addEventListener('click', startPractice);
                console.log('æ§åˆ¶é¢æ¿å¼€å§‹ç»ƒä¹ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
            }
            
            // é”™é¢˜é›†å¤é€‰æ¡†äº‹ä»¶ç›‘å¬å™¨
            const wrongQuestionsCheckbox = document.getElementById('wrongQuestionsOnly');
            if (wrongQuestionsCheckbox) {
                wrongQuestionsCheckbox.addEventListener('change', function() {
                    updateWrongQuestionsLabel();
                });
            }
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€æŒ‰é’®
            document.addEventListener('click', function(e) {
                if (e.target.id === 'wrongQuestionsBtn') {
                    showWrongQuestions();
                } else if (e.target.id === 'nextBtn') {
                    nextQuestion();
                } else if (e.target.id === 'prevBtn') {
                    prevQuestion();
                } else if (e.target.id === 'showAnswerBtn') {
                    console.log('æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®è¢«ç‚¹å‡»');
                    showAnswer();
                } else if (e.target.id === 'toggleAllAnswersBtn') {
                    toggleAllAnswers();
                } else if (e.target.id === 'deleteAllWrongBtn') {
                    deleteAllWrongQuestions();
                } else if (e.target.id === 'wrongSettingsBtn') {
                    showSettings();
                } else if (e.target.id === 'submitBtn') {
                    submitExam();
                } else if (e.target.id === 'backToStartBtn') {
                    backToStart();
                } else if (e.target.id === 'settingsBtn') {
                    showSettings();
                } else if (e.target.classList.contains('expand-answer-btn')) {
                    toggleAnswer(e.target);
                } else if (e.target.classList.contains('remove-wrong-question')) {
                    removeWrongQuestion(e.target.dataset.index);
                }
            });
            
            // å›è½¦é”®æäº¤ç­”æ¡ˆ
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        showAnswer();
                    }
                });
            }
        }

        function startPractice() {
            console.log('å¼€å§‹ç»ƒä¹ æŒ‰é’®è¢«ç‚¹å‡»');
            
            const practiceType = document.getElementById('practiceType').value;
            const unitSelect = document.getElementById('unitSelect').value;
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const wrongQuestionsOnly = document.getElementById('wrongQuestionsOnly').checked;
            const randomQuestions = document.getElementById('randomQuestions').checked;

            console.log('é€‰æ‹©çš„ç»ƒä¹ ç±»å‹:', practiceType);
            console.log('é€‰æ‹©çš„å•å…ƒ:', unitSelect);
            console.log('é¢˜ç›®æ•°é‡:', questionCount);
            console.log('é”™é¢˜é›†ç»ƒä¹ :', wrongQuestionsOnly);
            console.log('éšæœºå‡ºé¢˜:', randomQuestions);

            if (!allData) {
                alert('æ•°æ®è¿˜æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                return;
            }

            // ç­›é€‰é¢˜ç›®
            let filteredData = allData.data;
            
            if (wrongQuestionsOnly) {
                // ä»é”™é¢˜é›†ä¸­ç­›é€‰é¢˜ç›®
                const wrongQuestions = getWrongQuestions();
                if (wrongQuestions.length === 0) {
                    alert('é”™é¢˜é›†ä¸ºç©ºï¼Œè¯·å…ˆåšç»ƒä¹ å¹¶æ·»åŠ é”™é¢˜åˆ°é”™é¢˜é›†');
                    return;
                }
                // æ ¹æ®é”™é¢˜IDä»åŸå§‹æ•°æ®ä¸­æ‰¾åˆ°å¯¹åº”çš„é¢˜ç›®
                filteredData = allData.data.filter(item => 
                    wrongQuestions.some(wrong => wrong.id === item.id)
                );
            }
            
            // æ ¹æ®ç»ƒä¹ ç±»å‹ç­›é€‰
            if (practiceType === 'multiple_choice') {
                // ä»ç°æœ‰æ•°æ®ä¸­ç­›é€‰é€‰æ‹©é¢˜é¢˜ç›®
                filteredData = filteredData.filter(item => item.type === 'multiple_choice');
            } else if (practiceType !== 'all') {
                filteredData = filteredData.filter(item => item.type === practiceType);
            }
            
            if (unitSelect !== 'all') {
                filteredData = filteredData.filter(item => {
                    // å¯¹äºé€‰æ‹©é¢˜ï¼Œæ£€æŸ¥sourceå­—æ®µæ˜¯å¦åŒ…å«å•å…ƒä¿¡æ¯
                    //if (item.type === 'multiple_choice') {
                        // å¤„ç†Unit8å’ŒUnit 8çš„æ ¼å¼å·®å¼‚
                      //  const unitWithSpace = unitSelect.replace(/([A-Za-z]+)(\d+)/, '$1 $2');
                       // return item.source && (item.source.includes(unitSelect) || item.source.includes(unitWithSpace));
                    //}
                    // å¯¹äºå…¶ä»–é¢˜å‹ï¼Œæ£€æŸ¥tagså­—æ®µ
                    return item.tags && item.tags.some(tag => tag === unitSelect);
                });
            }

            if (filteredData.length === 0) {
                if (wrongQuestionsOnly) {
                    alert('é”™é¢˜é›†ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–å…ˆæ·»åŠ é”™é¢˜åˆ°é”™é¢˜é›†');
                //} else if (practiceType === 'multiple_choice') {
                //    alert('æŠ±æ­‰ï¼Œå½“å‰åªæœ‰ Unit 8 æœ‰é€‰æ‹©å¡«ç©ºé¢˜æ•°æ®ã€‚è¯·é€‰æ‹© Unit 8 æˆ–é€‰æ‹©"å…¨éƒ¨å•å…ƒ"æ¥ç»ƒä¹ é€‰æ‹©å¡«ç©ºé¢˜ã€‚');
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶');
                }
                return;
            }

            // æ ¹æ®éšæœºå‡ºé¢˜è®¾ç½®é€‰æ‹©é¢˜ç›®
            if (randomQuestions) {
                // éšæœºé€‰æ‹©é¢˜ç›®
                currentQuestions = getRandomQuestions(filteredData, Math.min(questionCount, filteredData.length));
            } else {
                // æŒ‰åŸå§‹é¡ºåºé€‰æ‹©é¢˜ç›®
                currentQuestions = filteredData.slice(0, Math.min(questionCount, filteredData.length));
            }
            
            // å¦‚æœå®é™…é¢˜ç›®æ•°é‡å°‘äºç”¨æˆ·è®¾ç½®çš„æ•°é‡ï¼Œæ˜¾ç¤ºæç¤º
            if (currentQuestions.length < questionCount) {
                alert(`æ ¹æ®æ‚¨çš„ç­›é€‰æ¡ä»¶ï¼Œåªæ‰¾åˆ°äº† ${currentQuestions.length} é“é¢˜ç›®ï¼Œå°‘äºæ‚¨è®¾ç½®çš„ ${questionCount} é“é¢˜ç›®ã€‚`);
            }
            
            currentQuestionIndex = 0;
            correctCount = 0;
            incorrectCount = 0;

            // åˆå§‹åŒ–é¢˜ç›®çŠ¶æ€æ•°ç»„
            questionStatus = new Array(currentQuestions.length).fill(null);

            // åˆå§‹åŒ–ç”¨æˆ·ç­”æ¡ˆæ•°ç»„
            initializeUserAnswers();
            
            // é‡ç½®äº¤å·ç›¸å…³å˜é‡
            questionResults = [];

            // æ›´æ–°UI
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('practiceScreen').classList.remove('hidden');
            document.getElementById('wrongQuestionsScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            // éšè—æ§åˆ¶é¢æ¿
            document.querySelector('.controls').classList.add('hidden');
            // ä¿æŒå¼€å§‹ç»ƒä¹ æŒ‰é’®å¯è§ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥é‡æ–°å¼€å§‹ç»ƒä¹ 

            updateStats();
            showQuestion();
        }
    </script>
</body>
</html> 